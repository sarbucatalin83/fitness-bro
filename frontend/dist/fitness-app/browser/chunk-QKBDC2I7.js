import{a as x}from"./chunk-TZIVW4B4.js";import{C as d,Ma as l,Na as k,a as u,b as c,o as p,s as g,va as m}from"./chunk-BPJZSODR.js";var f=class h{supabaseService=g(k);programService=g(x);currentWorkout=d(null);restTimerRunning=d(!1);restTimeRemaining=d(45);weeklyStatsData=d(null);loading=d(!1);activeWorkout=this.currentWorkout.asReadonly();isRestTimerRunning=this.restTimerRunning.asReadonly();restTime=this.restTimeRemaining.asReadonly();isLoading=this.loading.asReadonly();weeklyStats=m(()=>{let e=this.weeklyStatsData();return e||{volumeTrend:[],totalWorkouts:0,totalVolume:0}});currentExercise=m(()=>{let e=this.currentWorkout();return e&&e.exercises[e.currentExerciseIndex]||null});nextExercise=m(()=>{let e=this.currentWorkout();return e&&e.exercises[e.currentExerciseIndex+1]||null});constructor(){this.supabaseService.client.auth.onAuthStateChange((e,t)=>{t?this.loadWeeklyStats():this.weeklyStatsData.set(null)}),this.supabaseService.isAuthenticated()&&this.loadWeeklyStats()}getAuthHeaders(){return{Authorization:`Bearer ${this.supabaseService.getAccessToken()||l.supabaseAnonKey}`,"Content-Type":"application/json"}}async loadWeeklyStats(){try{let e=await fetch(`${l.supabaseUrl}/functions/v1/stats/weekly?weeks=1`,{headers:this.getAuthHeaders()});if(!e.ok)return;let t=await e.json();this.weeklyStatsData.set({volumeTrend:t.volumeTrend.map(n=>({day:n.day,volume:n.volume})),totalWorkouts:t.totalWorkouts,totalVolume:t.totalVolume})}catch(e){console.error("Error loading weekly stats:",e)}}async startWorkout(e,t){this.loading.set(!0);try{let n=await fetch(`${l.supabaseUrl}/functions/v1/workouts`,{method:"POST",headers:this.getAuthHeaders(),body:JSON.stringify({programId:e,dayId:t})});if(!n.ok)throw new Error("Failed to start workout");let s=await n.json(),o=(s.sets||[]).reduce((r,i)=>{let a=r.find(y=>y.exerciseId===i.exercise_id);return a||(a={exerciseId:i.exercise_id,exerciseName:i.exercise?.name||"Unknown",targetSets:0,targetReps:"10",lastPerformance:{weight:0,reps:0},sets:[]},r.push(a)),a.targetSets++,a.sets.push({id:i.id,setNumber:i.set_number,weight:i.weight,reps:i.reps,completed:i.completed,previousWeight:0,previousReps:0}),r},[]);this.currentWorkout.set({id:s.id,programId:e,dayId:t,dayName:s.workout_day?.name||"Workout",exercises:o,currentExerciseIndex:0,currentSetIndex:0,startTime:new Date(s.started_at),restTimer:45})}catch(n){console.error("Error starting workout:",n);let s=this.programService.getDayById(e,t);if(s){let o=s.exercises.map(r=>({exerciseId:r.exerciseId,exerciseName:r.exerciseName,targetSets:r.sets,targetReps:r.reps,lastPerformance:{weight:135,reps:10},sets:Array.from({length:r.sets},(i,a)=>({setNumber:a+1,weight:null,reps:null,completed:!1,previousWeight:135,previousReps:10}))}));this.currentWorkout.set({id:Date.now().toString(),programId:e,dayId:t,dayName:s.name,exercises:o,currentExerciseIndex:0,currentSetIndex:0,startTime:new Date,restTimer:45})}}finally{this.loading.set(!1)}}async updateSet(e,t,n){let s=this.currentWorkout();if(!s)return;let o=s.exercises[e]?.sets[t];if(o&&(this.currentWorkout.update(r=>{if(!r)return null;let i=[...r.exercises],a=[...i[e].sets];return a[t]=u(u({},a[t]),n),i[e]=c(u({},i[e]),{sets:a}),c(u({},r),{exercises:i})}),o.id))try{await fetch(`${l.supabaseUrl}/functions/v1/workouts/${s.id}/sets/${o.id}`,{method:"PATCH",headers:this.getAuthHeaders(),body:JSON.stringify({weight:n.weight??o.weight,reps:n.reps??o.reps,completed:n.completed??o.completed})})}catch(r){console.error("Error updating set:",r)}}completeSet(){let e=this.currentWorkout();if(!e)return;let{currentExerciseIndex:t,currentSetIndex:n}=e,s=e.exercises[t];this.updateSet(t,n,{completed:!0}),n<s.sets.length-1?(this.currentWorkout.update(o=>o?c(u({},o),{currentSetIndex:n+1}):null),this.startRestTimer()):t<e.exercises.length-1&&(this.currentWorkout.update(o=>o?c(u({},o),{currentExerciseIndex:t+1,currentSetIndex:0}):null),this.startRestTimer())}async addSet(){let e=this.currentWorkout();if(!e)return;let t=e.exercises[e.currentExerciseIndex],n=t.sets.length+1;this.currentWorkout.update(s=>{if(!s)return null;let o=[...s.exercises],r=u({},o[s.currentExerciseIndex]);return r.sets=[...r.sets,{setNumber:n,weight:null,reps:null,completed:!1,previousWeight:135,previousReps:10}],o[s.currentExerciseIndex]=r,c(u({},s),{exercises:o})});try{let s=await fetch(`${l.supabaseUrl}/functions/v1/workouts/${e.id}/sets`,{method:"POST",headers:this.getAuthHeaders(),body:JSON.stringify({exerciseId:t.exerciseId,setNumber:n})});if(s.ok){let o=await s.json();this.currentWorkout.update(r=>{if(!r)return null;let i=[...r.exercises],a=[...i[r.currentExerciseIndex].sets];return a[a.length-1]=c(u({},a[a.length-1]),{id:o.id}),i[r.currentExerciseIndex]=c(u({},i[r.currentExerciseIndex]),{sets:a}),c(u({},r),{exercises:i})})}}catch(s){console.error("Error adding set:",s)}}startRestTimer(){this.restTimerRunning.set(!0),this.restTimeRemaining.set(45)}stopRestTimer(){this.restTimerRunning.set(!1)}tickRestTimer(){this.restTimeRemaining.update(e=>Math.max(0,e-1))}async endWorkout(e){let t=this.currentWorkout();if(t){try{await fetch(`${l.supabaseUrl}/functions/v1/workouts/${t.id}/complete`,{method:"PUT",headers:this.getAuthHeaders(),body:JSON.stringify({notes:e})}),this.loadWeeklyStats()}catch(n){console.error("Error completing workout:",n)}this.currentWorkout.set(null),this.restTimerRunning.set(!1)}}getMaxVolume(){let e=this.weeklyStatsData();return!e||e.volumeTrend.length===0?1:Math.max(...e.volumeTrend.map(t=>t.volume),1)}static \u0275fac=function(t){return new(t||h)};static \u0275prov=p({token:h,factory:h.\u0275fac,providedIn:"root"})};export{f as a};
